<!DOCTYPE html>
<html>

<head>
  <style>
    div {
      margin-bottom: 0.5em;
    }

    #sel-name {
      white-space: pre-line;
      font-family: Consolas, monospace;
      font-size: 12px;
      color: #333;
    }
  </style>
</head>

<body>
  <div id="main-toolbar">
    <button id="btn-delete" title="Delete selected files">Delete</button>
  </div>
  <div id="secondary-toolbar"></div>
  <hr />
  <div id="file-info">
    <div id="sel-summary">(none)</div>
    <div id="sel-name" style="display:none"></div>
    <div id="sel-path" style="font-family: Consolas, monospace; font-size: 12px; color: #444">(no path)</div>
  </div>
  <hr />
  <div id="file-actions">
  </div>
  <script type="module">
    // script type="module" so we can use await

    // Helper to render current selection from AHK globals
    async function renderSelection () {
      try {
        const fileName = await ahk.global.SelectedFileName;
        const filePath = await ahk.global.SelectedFilePath;
        const namesAll = ( await ahk.global.SelectedNames ) || '';
        const count = Number( await ahk.global.SelectedCount ) || 0;
        const folderChain = ( await ahk.global.SelectedFolderPaths ) || '';
        const selSummary = document.querySelector( '#sel-summary' );
        const selName = document.querySelector( '#sel-name' );
        const selPath = document.querySelector( '#sel-path' );
        const actions = document.querySelector( '#file-actions' );

        if ( count > 1 ) {
          selSummary.innerText = `${ count } items selected`;
          selName.style.display = '';
          selName.innerText = namesAll.split( '\n' ).slice( 0, 10 ).join( '\n' );
          selPath.innerText = '(multiple paths)';
          // For multi-select, clear folder chain display
          actions.innerHTML = '';
        } else if ( count === 1 || ( fileName && fileName.trim() ) ) {
          selSummary.innerText = '1 item selected';
          selName.style.display = '';
          selName.innerText = fileName;
          selPath.innerText = filePath && filePath.trim() ? filePath : '(no path)';
          // Render parent-to-root folder chain
          const items = folderChain ? folderChain.split( '\n' ) : [];
          if ( items.length ) {
            const list = document.createElement( 'div' );
            list.style.fontFamily = 'Consolas, monospace';
            list.style.fontSize = '12px';
            list.style.color = '#333';
            list.style.whiteSpace = 'pre-line';
            list.textContent = items.join( '\n' );
            actions.innerHTML = '';
            actions.appendChild( list );
          } else {
            actions.innerHTML = '';
          }
        } else {
          selSummary.innerText = '(none)';
          selName.style.display = 'none';
          selName.innerText = '';
          selPath.innerText = '(no path)';
          actions.innerHTML = '';
        }
      } catch ( e ) {
        // ignore if globals not yet available
      }
    }

    // Wire up secondary toolbar: Exclude Folders
    const secondary = document.querySelector( '#secondary-toolbar' );
    const btnExclude = document.createElement( 'button' );
    btnExclude.id = 'btn-exclude-folders';
    btnExclude.title = 'Exclude folders (!folder:)';
    btnExclude.textContent = 'Exclude Folders';
    secondary.appendChild( btnExclude );

    btnExclude.addEventListener( 'click', async () => {
      try {
        await ahk.global.ExcludeFolders();
      } catch ( e ) {
        console.error( 'ExcludeFolders failed', e );
      }
    } );

    // Initial render and expose updater for AHK to call
    await renderSelection();
    window.updateSelectedFromAhk = renderSelection;

    // Enable/disable delete button based on selection and wire click
    const btnDelete = document.querySelector( '#btn-delete' );
    async function updateDeleteState () {
      try {
        const count = Number( await ahk.global.SelectedCount ) || 0;
        const filePath = await ahk.global.SelectedFilePath;
        btnDelete.disabled = !( count > 0 || ( filePath && filePath.trim() ) );
      } catch { }
    }
    await updateDeleteState();
    // Reuse existing updater to also update button state
    const oldUpdater = window.updateSelectedFromAhk;
    window.updateSelectedFromAhk = async function () {
      await oldUpdater();
      await updateDeleteState();
    };

    btnDelete.addEventListener( 'click', async () => {
      try {
        await ahk.global.DeleteSelected();
      } catch ( e ) {
        console.error( 'DeleteSelected failed', e );
      }
    } );
  </script>
</body>

</html>