<!DOCTYPE html>
<html>

<head>
  <style>
    /* layout */
    div {
      margin-bottom: 0.5em;
    }

    #main-toolbar,
    #secondary-toolbar {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* monospace helpers */
    .mono {
      white-space: pre-line;
      font-family: Consolas, monospace;
      font-size: 12px;
      color: #333;
    }

    .mono-dim {
      color: #444;
    }

    /* folder action buttons */
    .folder-btn {
      font-family: Consolas, monospace;
      font-size: 12px;
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .folder-btn.excluded {
      background: #fdd;
    }
  </style>
</head>

<body>
  <div id="main-toolbar">
    <button id="btn-delete" title="Delete selected files">Delete</button>
  </div>
  <div id="secondary-toolbar"></div>
  <hr />
  <div id="file-info">
    <div id="sel-summary">(none)</div>
    <div id="sel-name" class="mono" style="display:none"></div>
    <div id="sel-path" class="mono mono-dim">(no path)</div>
  </div>
  <hr />
  <div id="file-actions">
  </div>
  <script type="module">
    // script type="module" so we can use await

    // DOM refs
    const els = {
      summary: document.querySelector( '#sel-summary' ),
      name: document.querySelector( '#sel-name' ),
      path: document.querySelector( '#sel-path' ),
      actions: document.querySelector( '#file-actions' ),
      secondary: document.querySelector( '#secondary-toolbar' ),
      btnDelete: document.querySelector( '#btn-delete' )
    };

    // Helpers
    const setExcludedStyle = ( btn, excluded ) => {
      btn.classList.toggle( 'excluded', !!excluded );
    };

    async function isExcluded ( folder ) {
      const curr = await ahk.getControlText( 'Edit1', 'ahk_class EVERYTHING_(1.5a)' );
      // Everything exclusion syntax for a path: !"C:\\Path"
      const excl = `!"${ folder }"`;
      return !!curr && curr.includes( excl );
    }

    function renderFolderButtons ( items ) {
      if ( !items?.length ) { els.actions.innerHTML = ''; return; }
      els.actions.innerHTML = '';
      const btns = document.createElement( 'div' );
      btns.style.display = 'flex';
      btns.style.flexDirection = 'column';
      btns.style.gap = '2px';
      items.forEach( ( folder ) => {
        const row = document.createElement( 'div' );
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '8px';

        // Folder path label
        const folderLabel = document.createElement( 'span' );
        folderLabel.className = 'mono';
        folderLabel.textContent = folder;
        row.appendChild( folderLabel );

        // Buttons container
        const btnGroup = document.createElement( 'span' );
        btnGroup.style.display = 'flex';
        btnGroup.style.gap = '4px';

        // Exclude button
        const btnExclude = document.createElement( 'button' );
        btnExclude.className = 'folder-btn';
        btnExclude.textContent = 'Exclude';
        btnExclude.title = `Toggle exclusion for ${ folder }`;
        ( async () => setExcludedStyle( btnExclude, await isExcluded( folder ) ) )();
        btnExclude.addEventListener( 'click', async () => {
          await ahk.global.ToggleExcludeFolder( folder );
          setExcludedStyle( btnExclude, await isExcluded( folder ) );
        } );

        // Search-only button
        const btnOnly = document.createElement( 'button' );
        btnOnly.className = 'folder-btn only';
        btnOnly.textContent = 'Only';
        btnOnly.title = `Toggle search only in ${ folder }`;
        btnOnly.dataset.active = 'false';
        function setOnlyStyle ( active ) {
          btnOnly.style.background = active ? '#dfd' : '';
        }
        btnOnly.addEventListener( 'click', async () => {
          const isActive = btnOnly.dataset.active === 'true';
          btnOnly.dataset.active = ( !isActive ).toString();
          setOnlyStyle( !isActive );
          if ( !isActive ) {
            if ( window.ahk?.global?.SetSearchOnlyFolder ) {
              await ahk.global.SetSearchOnlyFolder( folder );
            }
          } else {
            if ( window.ahk?.global?.ClearSearchOnlyFolder ) {
              await ahk.global.ClearSearchOnlyFolder( folder );
            }
          }
        } );
        setOnlyStyle( false );

        btnGroup.appendChild( btnExclude );
        btnGroup.appendChild( btnOnly );
        row.appendChild( btnGroup );
        btns.appendChild( row );
      } );
      els.actions.appendChild( btns );
    }

    // Render current selection from AHK globals
    async function renderSelection () {
      try {
        const [ fileName, filePath, namesAll, countRaw, folderChain ] = await Promise.all( [
          ahk.global.SelectedFileName,
          ahk.global.SelectedFilePath,
          ahk.global.SelectedNames,
          ahk.global.SelectedCount,
          ahk.global.SelectedFolderPaths,
        ] );
        const count = Number( countRaw ) || 0;
        if ( count > 1 ) {
          els.summary.innerText = `${ count } items selected`;
          els.name.style.display = '';
          els.name.innerText = ( namesAll || '' ).split( '\n' ).slice( 0, 10 ).join( '\n' );
          els.path.innerText = '(multiple paths)';
          els.actions.innerHTML = '';
          return;
        }
        if ( count === 1 || ( fileName && fileName.trim() ) ) {
          els.summary.innerText = '1 item selected';
          els.name.style.display = '';
          els.name.innerText = fileName || '';
          els.path.innerText = filePath && filePath.trim() ? filePath : '(no path)';
          const items = folderChain ? folderChain.split( '\n' ) : [];
          renderFolderButtons( items );
          return;
        }
        // none selected
        els.summary.innerText = '(none)';
        els.name.style.display = 'none';
        els.name.innerText = '';
        els.path.innerText = '(no path)';
        els.actions.innerHTML = '';
      } catch { /* ignore if globals not yet available */ }
    }

    // Secondary toolbar: Exclude Folders toggle (!folder:)
    const btnExclude = document.createElement( 'button' );
    btnExclude.id = 'btn-exclude-folders';
    btnExclude.title = 'Exclude folders (!folder:)';
    btnExclude.textContent = 'Exclude Folders';
    els.secondary.appendChild( btnExclude );
    btnExclude.addEventListener( 'click', async () => {
      try { await ahk.global.ExcludeFolders(); } catch ( e ) { console.error( 'ExcludeFolders failed', e ); }
    } );

    // Delete button state and action
    async function updateDeleteState () {
      try {
        const [ countRaw, filePath ] = await Promise.all( [
          ahk.global.SelectedCount,
          ahk.global.SelectedFilePath,
        ] );
        const count = Number( countRaw ) || 0;
        els.btnDelete.disabled = !( count > 0 || ( filePath && filePath.trim() ) );
      } catch { /* ignore */ }
    }
    els.btnDelete.addEventListener( 'click', async () => {
      try { await ahk.global.DeleteSelected(); } catch ( e ) { console.error( 'DeleteSelected failed', e ); }
    } );

    // Initial render and expose updater for AHK to call
    await renderSelection();
    await updateDeleteState();
    const oldUpdater = renderSelection;
    window.updateSelectedFromAhk = async () => { await oldUpdater(); await updateDeleteState(); };
  </script>
</body>

</html>